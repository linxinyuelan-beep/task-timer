# Task Timer - macOS 置顶任务管理工具

## 项目概述

一个 macOS 桌面应用程序，能够在所有应用程序（包括全屏应用）之上显示时间和任务列表，帮助用户保持专注和时间管理。

## 核心功能需求

### 1. 置顶显示功能

#### 1.1 窗口层级
- **需求描述**：应用窗口必须始终显示在所有其他应用程序之上
- **技术要点**：
  - 使用 `NSWindow.level = .floating` 或更高级别（如 `.statusBar`, `.popUpMenu`）
  - 对于全屏应用，需要设置 `collectionBehavior` 包含 `.canJoinAllSpaces` 和 `.stationary`
  - 窗口应该在所有 Mission Control Space 中可见

#### 1.2 窗口行为
- 窗口应该是半透明的（可配置透明度）
- 窗口可以自由拖动和调整大小
- 窗口不应该影响其他应用的焦点
- 点击穿透选项（可选）：允许鼠标点击穿透到下层应用

### 2. 时间显示功能

#### 2.1 基础时间显示
- **当前时间**：实时显示系统时间
  - 格式：HH:mm:ss（24小时制）
  - 可选格式：12小时制
  - 日期显示：YYYY年MM月DD日 星期X

#### 2.2 计时器功能
- **正计时**：从指定时间开始计时
- **倒计时**：设置目标时间倒计时
- **番茄钟模式**：
  - 工作时长：25分钟（可自定义）
  - 短休息：5分钟（可自定义）
  - 长休息：15分钟（可自定义）
  - 完成提醒：声音/通知

#### 2.3 时间统计
- 记录每个任务的总耗时
- 今日/本周/本月时间统计
- 时间使用可视化图表

### 3. 任务列表功能

#### 3.1 基础任务管理
- **添加任务**：
  - 任务标题（必填）
  - 任务描述（可选）
  - 优先级标记（高/中/低）
  - 标签/分类
  - 预计时长

- **任务操作**：
  - 标记完成/未完成
  - 编辑任务
  - 删除任务
  - 任务排序（手动拖拽/按优先级/按时间）

#### 3.2 任务状态
- 待办（Todo）
- 进行中（In Progress）
- 已完成（Completed）
- 已归档（Archived）

#### 3.3 任务过滤与搜索
- 按状态筛选
- 按优先级筛选
- 按标签筛选
- 关键词搜索

### 4. 数据持久化

#### 4.1 本地存储
- 使用 Core Data 或 SQLite 存储任务数据
- 使用 UserDefaults 存储用户偏好设置
- 定期自动保存

#### 4.2 数据备份
- 支持导出数据（JSON/CSV格式）
- 支持导入数据
- iCloud 同步（可选功能）

### 5. 用户界面

#### 5.1 窗口布局
```
┌─────────────────────────────────┐
│  [≡] Task Timer    [□] [×]      │  ← 标题栏
├─────────────────────────────────┤
│                                 │
│   ⏰ 14:32:45                   │  ← 时间显示
│   2025年10月21日 星期二          │
│                                 │
│   🍅 专注模式: 23:15             │  ← 计时器
│                                 │
├─────────────────────────────────┤
│   [+] 添加任务    [🔍] [⚙️]     │  ← 工具栏
├─────────────────────────────────┤
│                                 │
│  ☐ 完成需求文档编写         [H] │  ← 任务列表
│     标签: 工作 | 2小时           │
│                                 │
│  ☑ 回复邮件                 [M] │
│     标签: 沟通 | 30分钟         │
│                                 │
│  ☐ 学习 SwiftUI             [L] │
│     标签: 学习 | 1小时          │
│                                 │
└─────────────────────────────────┘
```

#### 5.2 UI 特性
- **简洁设计**：避免过多装饰，保持信息清晰
- **暗色/亮色模式**：跟随系统或手动切换
- **可调整透明度**：0-100%
- **紧凑模式**：只显示必要信息，节省屏幕空间
- **展开模式**：显示完整任务详情

#### 5.3 交互设计
- 双击任务进入编辑模式
- 右键菜单显示更多操作
- 键盘快捷键支持
- 拖拽调整窗口大小和位置

### 6. 系统集成

#### 6.1 菜单栏图标
- 常驻菜单栏
- 快速访问主要功能
- 显示当前任务/计时状态

#### 6.2 通知中心
- 任务提醒通知
- 计时器完成通知
- 可自定义通知声音

#### 6.3 权限需求
- 辅助功能权限（用于全屏覆盖）
- 通知权限
- 文件访问权限（导入/导出）

### 7. 设置与偏好

#### 7.1 外观设置
- 主题选择（亮色/暗色/自动）
- 窗口透明度
- 字体大小
- 颜色方案

#### 7.2 行为设置
- 开机自启动
- 默认窗口位置
- 点击穿透开关
- 自动隐藏条件

#### 7.3 功能设置
- 番茄钟时长配置
- 提醒方式设置
- 数据同步设置
- 快捷键配置

## 技术实现方案

### 技术栈选择

#### 方案一：SwiftUI + AppKit（推荐）
- **优势**：
  - 现代化开发体验
  - 原生性能
  - 完整的 macOS 系统 API 支持
  - 良好的未来兼容性
- **技术点**：
  - SwiftUI 构建 UI
  - AppKit 处理窗口层级和全屏支持
  - Combine 处理数据流
  - Core Data 数据持久化

#### 方案二：Electron
- **优势**：
  - 跨平台（可扩展到 Windows/Linux）
  - 丰富的 Web 技术生态
  - 开发效率高
- **劣势**：
  - 内存占用较大
  - 包体积大
  - 全屏覆盖实现较复杂

### 关键技术实现

#### 1. 全屏应用覆盖实现

```swift
// 窗口配置
window.level = .floating  // 或 .statusBar
window.collectionBehavior = [
    .canJoinAllSpaces,    // 在所有空间显示
    .stationary,          // 不随空间切换
    .fullScreenAuxiliary  // 全屏辅助窗口
]
```

#### 2. 窗口透明与点击穿透

```swift
// 透明窗口
window.isOpaque = false
window.backgroundColor = .clear
window.alphaValue = 0.9

// 点击穿透（可选）
window.ignoresMouseEvents = true  // 启用穿透
```

#### 3. 保持窗口激活状态

```swift
// 监听应用切换
NSWorkspace.shared.notificationCenter.addObserver(
    forName: NSWorkspace.didActivateApplicationNotification
) { _ in
    window.orderFrontRegardless()  // 强制置顶
}
```

## 开发计划

### Phase 1: MVP 核心功能（2周）
- [ ] 项目框架搭建
- [ ] 置顶窗口实现（包括全屏支持）
- [ ] 基础时间显示
- [ ] 简单任务列表（增删改查）
- [ ] 本地数据存储

### Phase 2: 增强功能（2周）
- [ ] 计时器功能（正计时/倒计时）
- [ ] 番茄钟模式
- [ ] 任务优先级和标签
- [ ] 搜索和过滤功能
- [ ] 通知提醒

### Phase 3: UI/UX 优化（1周）
- [ ] 暗色/亮色模式
- [ ] 透明度调整
- [ ] 紧凑/展开模式切换
- [ ] 动画效果
- [ ] 快捷键支持

### Phase 4: 高级功能（2周）
- [ ] 时间统计和图表
- [ ] 数据导入/导出
- [ ] iCloud 同步
- [ ] 菜单栏集成
- [ ] 开机自启动

### Phase 5: 测试与发布（1周）
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户测试
- [ ] 应用签名
- [ ] 应用商店发布

## 技术难点与解决方案

### 难点1：全屏应用覆盖
**问题**：普通的窗口层级无法覆盖全屏应用

**解决方案**：
1. 使用 `.fullScreenAuxiliary` 集合行为
2. 设置窗口层级为 `.statusBar` 或更高
3. 必要时请求辅助功能权限
4. 使用 `orderFrontRegardless()` 强制置顶

### 难点2：点击穿透与交互平衡
**问题**：启用点击穿透后无法与窗口交互

**解决方案**：
1. 提供"锁定模式"切换
2. 使用热键或菜单栏切换交互模式
3. 智能检测：hover 时暂时禁用穿透

### 难点3：性能优化
**问题**：实时更新可能消耗性能

**解决方案**：
1. 使用 `Timer.publish()` 而非高频轮询
2. 列表虚拟化（大量任务时）
3. 合理使用 SwiftUI 的 `@State` 和 `@Published`
4. 避免不必要的视图重绘

## 后续扩展功能

### 1. 团队协作
- 共享任务列表
- 任务分配
- 进度同步

### 2. 数据分析
- 时间使用报告
- 生产力趋势分析
- 任务完成率统计

### 3. 集成功能
- 日历集成
- Reminders 集成
- Jira/Trello 集成

### 4. AI 辅助
- 智能任务优先级建议
- 时间预估
- 工作习惯分析

## 设计原则

1. **简洁至上**：界面清晰，功能直观
2. **不打扰**：虽然置顶但不应过度干扰工作
3. **高效**：快速添加和管理任务
4. **灵活**：高度可自定义
5. **原生体验**：遵循 macOS Human Interface Guidelines

## 参考资料

- [macOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/macos)
- [NSWindow Level Documentation](https://developer.apple.com/documentation/appkit/nswindow/level)
- [SwiftUI macOS Tutorial](https://developer.apple.com/tutorials/swiftui)
- 类似应用参考：
  - itsycal（菜单栏日历）
  - Dato（时间工具）
  - Horo（计时器）
  - Things/Todoist（任务管理）

## 总结

该项目在技术上完全可行，macOS 提供了完善的 API 支持窗口置顶和全屏覆盖。关键是要合理使用 `NSWindow` 的 `level` 和 `collectionBehavior` 属性，并可能需要请求辅助功能权限以确保在所有场景下都能正常工作。

建议使用 **SwiftUI + AppKit** 的混合方案开发，既能享受现代化的开发体验，又能充分利用 macOS 的原生能力。
